# Классификатор ЭКГ сигналов

Целью данного проекта является исследование качества предсказания нейронной сети с архитектурой **ResNet1d18** на датасете **PTB-XL**. Для исследования были выбраны 5 нарушений ритма: синусовый ритм, аритмия, брадикардия, тахикардия, фибрилляция предсердий.

Также была написана библиотека **ecg_classification**, которая позволяет воспроизводить данный эксперимент. Она позволяет предобрабатывать датасет **PTB-XL**, обучать нейросеть **ResNet1d**.

## Скачивание и установка проекта

1. Установка:

```CMake
git clone https://github.com/EntryFrager/ecg_classifier.git
cd ./ecg_classifier
```

2. Установка зависимостей, создание виртуальной среды и загрузка датасета **PTB-XL**:
```
bash ./scripts/setup_venv.sh
bash ./scripts/download_datasets.sh
```

3. Сборка и запуск пакета:
```python
pip install -e .
ecg_classification
```

## Немного о PTB-XL

Датасет **PTB-XL** содержит 21837 записей от 18885 пациентов продолжительностью 10 секунд. Данные ЭКГ-сигналов были аннотированы двумя кардиологами в виде набора данных с несколькими метками, в котором диагностические метки были дополнительно объединены в супер- и подклассы. Набор данных охватывает широкий спектр диагностических классов, включая, в частности, большую часть записей о состоянии здоровья.

В столбце **scp_codes** содержится информация о заболеваниях пациента. Эта информация хранится в виде словаря, где ключ заболевание, а значение - вероятность заболевания. 

[!IMPORTANT]
В данном проекте было принято считать, что если заболевание указано как ключ, то для него бинарная метка выставляется как 1, иначе 0.

Сами экг сигналы хранятся в отдельных файлах, названия которых указаны в столбцах **filename_lr** и **filename_hr**. В первом столбце хранятся названия файлов, в которые были записаны экг с частотой 100 Гц, а во втором - с частотой 500 Гц.

[!NOTE]
Подробнее о PTB-XL вы можете прочитать [здесь](https://physionet.org/content/ptb-xl/1.0.3/) и [здесь](https://pmc.ncbi.nlm.nih.gov/articles/PMC7248071/)

## Класс ECGDataset

Класс **ECGDataset** наследуется от **torch.utils.Dataset** и позволяет предобработать датасет **PTB-XL**. Рассмотрим основные функции класса:
1. **_set_target_labels** выставляет бинарные метки для исследуемых болезней.
2. **_process_ecg_signals** выделяет нужные нам названия файлов с определенной частотой записи.
3. **_process_metadata** обрабатывает конкретные метаданные, а именно вес, возраст и рост.
4. Функция **get_dataset** реализует подготовку обучающей, валидационной и тестовой выборки.
5. **\_\_getitem\_\_** возвращает элемент датасета по индексу, загружая файл экг сигнала и производя его нормализацию и перевод в тензор.

Также были реализованы классы **Compose**, **Normalize**, **ToTensor** под данный датасет.

## Класс ResNet

Класс **ResNet** содержит архитектуру нейросети, переписанную под **1d**. Также и с **BasicBlock** и **BottleNeck**. 

Реализованы функции **train** и **test**, класс **EarlyStopping**. Особенно важна функция **get_metrics**, которая подсчитывает все важные метрики и выводит их в таком виде. 
```
Epoch 1/30:

Validation metrics:
Confusion matrix:
  TP  FP  TN  FN
1739 203 198  53
 TP  FP   TN  FN
 35 440 1661  57
 TP  FP   TN  FN
 59  16 2091  27
 TP  FP   TN  FN
 31  18 2111  33
 TP  FP   TN  FN
121  73 1964  35

Micro averaging:
sensitivity  0.906393
specificity  0.914530
precision    0.725777
f1 score     0.806091

Macro averaging:
sensitivity  0.659384
specificity  0.846491
precision    0.602437
f1 score     0.629625

ROC AUC: 0.8822

Classification report from sklearn:
              precision    recall  f1-score   support

           0       0.90      0.97      0.93      1792
           1       0.07      0.38      0.12        92
           2       0.79      0.69      0.73        86
           3       0.63      0.48      0.55        64
           4       0.62      0.78      0.69       156

   micro avg       0.73      0.91      0.81      2190
   macro avg       0.60      0.66      0.61      2190
weighted avg       0.83      0.91      0.86      2190
 samples avg       0.77      0.87      0.80      2190


train Loss: 0.3307
val Loss: 0.5607
```
А также при обучении подбирает наилучший **threshold** для бинаризации предсказаний модели.

[!NOTE]
Если вы желаете разобраться, что это за метрики и что они показывают, то вам [сюда](https://habr.com/ru/articles/821547/), или [сюда](https://education.yandex.ru/handbook/ml/article/metriki-klassifikacii-i-regressii)

## Передача гиперпараметров

Для удобства работы с проектом была внедрена **Hydra**. Это позволяет вам не менять значения гиперпараметров в коде, а менять их в конфигах, что гораздо удобнее и проще.

## Результаты

## Обсуждение результатов

## Вывод

## Источники информации

1. https://physionet.org/content/ptb-xl/1.0.3/
2. https://pmc.ncbi.nlm.nih.gov/articles/PMC7248071/
3. https://docs.pytorch.org/vision/main/models/resnet.html
4. https://hydra.cc/docs/intro/
5. https://habr.com/ru/articles/821547/
6. https://education.yandex.ru/handbook/ml/article/metriki-klassifikacii-i-regressii